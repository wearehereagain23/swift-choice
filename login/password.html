<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Swift Choice - Forgot Password</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
	<script src="../config.js"></script>

	<style>
		*,
		*::before,
		*::after {
			box-sizing: border-box;
		}

		body {
			margin: 0;
			font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
			background: #f2f6f7;
			display: flex;
			align-items: center;
			justify-content: center;
			min-height: 100vh;
			padding: clamp(12px, 4vw, 32px);
		}

		.container {
			width: 100%;
			max-width: 980px;
			background: #fff;
			border-radius: 16px;
			box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
			display: grid;
			grid-template-columns: 1fr;
			overflow: hidden;
		}

		/* Left side */
		.info-panel {
			background: linear-gradient(135deg, #0a8f4d, #067c3b);
			color: #fff;
			padding: clamp(24px, 6vw, 48px);
			text-align: center;
			display: flex;
			flex-direction: column;
			justify-content: center;
		}

		.info-logo {
			width: clamp(64px, 12vw, 100px);
			height: auto;
			margin: 0 auto 20px;
		}

		.info-title {
			font-size: clamp(22px, 4vw, 30px);
			font-weight: 700;
			margin-bottom: 12px;
		}

		.info-text {
			font-size: clamp(14px, 2.5vw, 16px);
			line-height: 1.6;
			opacity: 0.95;
			margin-bottom: 20px;
		}

		.info-hint {
			font-size: 13px;
			opacity: 0.8;
			margin-top: auto;
		}

		/* Right side */
		.form-panel {
			padding: clamp(24px, 6vw, 48px);
			display: flex;
			flex-direction: column;
			align-items: center;
			text-align: center;
		}

		.form-title {
			color: #0a8f4d;
			font-size: clamp(20px, 4vw, 28px);
			font-weight: 700;
			margin: 0;
		}

		.form-sub {
			margin: 6px 0 16px;
			color: #475569;
			font-size: clamp(13px, 2.5vw, 15px);
			max-width: 360px;
			line-height: 1.5;
		}

		form {
			width: 100%;
			max-width: 460px;
			display: grid;
			gap: 14px;
			margin-top: 12px;
		}

		input[type="email"] {
			width: 100%;
			padding: 14px 18px;
			border: 1px solid #cbd5e1;
			border-radius: 999px;
			font-size: 16px;
			outline: none;
			transition: border-color 0.2s, box-shadow 0.2s;
		}

		input:focus {
			border-color: #0a8f4d;
			box-shadow: 0 0 0 3px rgba(10, 143, 77, 0.15);
		}

		.btn {
			width: 100%;
			padding: 14px 20px;
			background: #0a8f4d;
			color: #fff;
			border-radius: 999px;
			font-weight: 700;
			font-size: 15px;
			cursor: pointer;
			transition: background 0.2s ease;
		}

		.btn:hover {
			background: #067c3b;
		}

		.muted {
			color: #64748b;
			font-size: 13px;
			margin-top: 16px;
		}

		.link {
			color: #0a8f4d;
			text-decoration: none;
			font-weight: 500;
		}

		.link:hover {
			text-decoration: underline;
		}

		@media (min-width: 880px) {
			.container {
				grid-template-columns: 1fr 1fr;
			}

			.info-panel {
				text-align: left;
			}
		}
	</style>

</head>

<body>
	<div class="container">
		<section class="info-panel">
			<img src="../icon-512.png" class="info-logo" />
			<h2 class="info-title">Forgot your password?</h2>
			<p class="info-text">Enter your registered email. We’ll send you an OTP to reset your password securely.</p>
		</section>

		<section class="form-panel">
			<h2 class="form-title">Reset Access</h2>
			<form id="forgotForm">
				<input type="email" name="email" placeholder="Enter your email" required />
				<button type="submit" class="btn">Send OTP</button>
			</form>
			<p class="muted">Remembered your password? <a href="index.html" class="link">Back to login</a></p>
		</section>
	</div>

	<div id="spinnerModal" class="spinner-modal" style="display:none;">
		<div class="spinner-content">
			<div class="spinner"></div>
			<p>Loading...</p>
		</div>
	</div>
	<script>
		// === Initialize Firebase ===
		firebase.initializeApp(CONFIG.FIREBASE);
		const auth = firebase.auth();
		const db = firebase.firestore();

		// === Spinner Helpers ===
		function showSpinner() { document.getElementById('spinnerModal').style.display = 'flex'; }
		function hideSpinner() { document.getElementById('spinnerModal').style.display = 'none'; }
		function generateOtp() { return Math.floor(100000 + Math.random() * 900000).toString(); }

		async function sendOtpEmail(email, name, code) {
			const adminDoc = await db.collection("admin").doc("admin").get();
			const adminPass = adminDoc.exists ? adminDoc.data().pass : "";
			const payload = {
				email, name, bank: "Swift Choice", code,
				host: 'mail.assistin.online', adminEmail: 'swiftchoice@assistin.online',
				pass: adminPass, from: '<noreply@assistin.online>',
				link: 'https://swift-choice.web.app/contact/index.html',
				image: "https://tkolyezukxoefqjzhqar.supabase.co/storage/v1/object/public/logos/IMG_0307.PNG"
			};
			try {
				const res = await fetch("https://api-sender-service-runner.vercel.app/api/bank/password", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify(payload)
				});
				return res.ok;
			} catch (err) {
				console.warn("Email send failed:", err);
				return false;
			}
		}

		// === OTP Modal with Timer ===
		async function showOtpPopupWithTimer(email, firstname, initialOtp) {
			let currentOtp = initialOtp;
			let secondsLeft = 50;
			let timerInterval = null;

			function startTimer(countdownEl, timerRow, resendRow) {
				if (timerInterval) clearInterval(timerInterval);
				secondsLeft = 50;
				countdownEl.textContent = secondsLeft;
				timerRow.style.display = 'block';
				resendRow.style.display = 'none';
				timerInterval = setInterval(() => {
					secondsLeft--;
					if (secondsLeft > 0) {
						countdownEl.textContent = secondsLeft;
					} else {
						clearInterval(timerInterval);
						timerInterval = null;
						timerRow.style.display = 'none';
						resendRow.style.display = 'block';
					}
				}, 1000);
			}

			return new Promise((resolve) => {
				Swal.fire({
					title: 'Enter OTP',
					html: `
          <input id="otpInput" class="swal2-input" placeholder="Enter OTP">
          <div id="timerRow">Resend available in <strong id="countdown">${secondsLeft}</strong>s</div>
          <div id="resendRow" style="display:none; margin-top:8px;">
            Didn't get it? <button id="resendBtn" type="button" style="background:none;border:none;color:#60a5fa;cursor:pointer;padding:0">Resend</button>
          </div>`,
					background: '#0C290F',
					customClass: { popup: 'swal2Style' },
					showCancelButton: true,
					confirmButtonText: 'Verify',
					confirmButtonColor: 'green',
					allowOutsideClick: false,
					didOpen: () => {
						const c = Swal.getHtmlContainer();
						const countdownEl = c.querySelector('#countdown');
						const timerRow = c.querySelector('#timerRow');
						const resendRow = c.querySelector('#resendRow');
						const resendBtn = c.querySelector('#resendBtn');
						startTimer(countdownEl, timerRow, resendRow);

						resendBtn.addEventListener('click', async () => {
							startTimer(countdownEl, timerRow, resendRow);
							currentOtp = generateOtp();
							showSpinner();
							const ok = await sendOtpEmail(email, firstname, currentOtp);
							hideSpinner();
							if (!ok) {
								Swal.showValidationMessage('Failed to resend OTP. Try again.');
								setTimeout(() => Swal.resetValidationMessage(), 1600);
							} else {
								Swal.showValidationMessage('OTP resent — check your email.');
								setTimeout(() => Swal.resetValidationMessage(), 1400);
							}
						});
					},
					preConfirm: () => {
						const val = Swal.getPopup().querySelector('#otpInput').value.trim();
						if (!val) {
							Swal.showValidationMessage('Please enter the OTP.');
							return false;
						}
						if (val !== currentOtp) {
							Swal.showValidationMessage('Invalid OTP. Please try again.');
							return false;
						}
						return val;
					},
					willClose: () => {
						if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
					}
				}).then((res) => res.isConfirmed ? resolve(true) : resolve(false));
			});
		}

		async function showResetPasswordPopup() {
			const { value: newPassword } = await Swal.fire({
				title: 'Reset Password',
				html: `
        <input id="pwd1" type="password" class="swal2-input" placeholder="New password">
        <input id="pwd2" type="password" class="swal2-input" placeholder="Confirm new password">`,
				focusConfirm: false,
				showCancelButton: true,
				confirmButtonText: 'Change password',
				background: '#0C290F',
				confirmButtonColor: 'green',
				customClass: { popup: 'swal2Style' },
				preConfirm: () => {
					const p1 = Swal.getPopup().querySelector('#pwd1').value.trim();
					const p2 = Swal.getPopup().querySelector('#pwd2').value.trim();
					if (!p1 || !p2) {
						Swal.showValidationMessage('Both fields are required.');
						return false;
					}
					if (p1 !== p2) {
						Swal.showValidationMessage('Passwords do not match.');
						return false;
					}
					return p1;
				}
			});
			return newPassword || null;
		}

		// === Forgot Password Form Handler ===
		document.getElementById("forgotForm").addEventListener("submit", async (e) => {
			e.preventDefault();
			showSpinner();
			const email = e.target.email.value.trim().toLowerCase();

			try {
				// Get user from Firestore
				const snap = await db.collection("users").where("email", "==", email).limit(1).get();
				if (snap.empty) {
					hideSpinner();
					return Swal.fire({
						title: "Email not registered",
						icon: "error",
						background: "#0C290F",
						customClass: { popup: 'swal2Style' },
						confirmButtonColor: "green"
					});
				}

				const userDoc = snap.docs[0];
				const userData = userDoc.data();
				const oldPassword = userData.password;

				// Send OTP
				let otp = generateOtp();
				const sent = await sendOtpEmail(email, userData.firstname, otp);
				hideSpinner();
				if (!sent) {
					return Swal.fire({
						title: "Failed to send OTP",
						icon: "error",
						background: "#0C290F",
						customClass: { popup: 'swal2Style' },
						confirmButtonColor: "green"
					});
				}

				// Verify OTP
				const verified = await showOtpPopupWithTimer(email, userData.firstname, otp);
				if (!verified) return;

				// Get new password
				const newPassword = await showResetPasswordPopup();
				if (!newPassword) return;

				// Sign in with old password
				showSpinner();
				const cred = await auth.signInWithEmailAndPassword(email, oldPassword);

				// Update Auth password
				await cred.user.updatePassword(newPassword);

				// Update Firestore password field
				await userDoc.ref.update({ password: newPassword });

				// Log out the user
				await auth.signOut();
				hideSpinner();

				// Success
				Swal.fire({
					title: "Password Changed",
					text: "Your password has been updated. Please log in with your new password.",
					icon: "success",
					background: "#0C290F",
					customClass: { popup: 'swal2Style' },
					confirmButtonColor: "green"
				}).then(() => {
					location.href = "index.html";
				});

			} catch (err) {
				console.error("Forgot password error:", err);
				hideSpinner();
				Swal.fire({
					title: "Error",
					text: err.message || "Something went wrong",
					icon: "error",
					background: "#0C290F",
					customClass: { popup: 'swal2Style' },
					confirmButtonColor: "green"
				});
			}
		});
	</script>





	<style>
		.swal2Style {
			color: white;
		}

		.swal2-confirm {
			background-color: #006f8b;
		}

		.swal2-popup {
			background-color: #00092c;
		}

		.swal2-confirm:hover {
			background-color: #00313d;
		}
	</style>

	<!-- SPINNER CSS -->
	<style>
		.spinner-modal {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.6);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 9999;
		}

		.spinner-content {
			text-align: center;
			color: white;
		}

		.spinner {
			border: 6px solid #f3f3f3;
			border-top: 6px solid #ffffff;
			border-radius: 50%;
			width: 50px;
			height: 50px;
			animation: spin 1s linear infinite;
			margin: 0 auto 10px;
		}

		@keyframes spin {
			0% {
				transform: rotate(0deg);
			}

			100% {
				transform: rotate(360deg);
			}
		}
	</style>
</body>

</html>